import logging
import sqlite3
from datetime import datetime
from aiogram import Bot, Dispatcher, types
from aiogram.contrib.middlewares.logging import LoggingMiddleware
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils import executor

# ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
BOT_TOKEN = "–í–ê–®_–¢–û–ö–ï–ù_–°–Æ–î–ê"  # –¢–æ–∫–µ–Ω –æ—Ç @BotFather

# ========== –ë–ê–ó–ê –í–û–ü–†–û–°–û–í ==========
QUESTIONS = {
    'python': [
        {'question': '–ö–∞–∫ –≤—ã–≤–µ—Å—Ç–∏ —Ç–µ–∫—Å—Ç –≤ Python?', 'options': ['print("text")', 'console.log("text")', 'echo "text"', 'System.out.println("text")'], 'correct': 0},
        {'question': '–ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≤ Python?', 'options': ['list = []', 'array = []', 'arr = []', 'list()'], 'correct': 0},
        {'question': '–ö–∞–∫–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–ª–∏–Ω—É —Å–ø–∏—Å–∫–∞?', 'options': ['size()', 'length()', 'len()', 'count()'], 'correct': 2},
        {'question': '–ö–∞–∫ –æ–±—ä—è–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –≤ Python?', 'options': ['function myFunc():', 'def myFunc():', 'func myFunc():', 'define myFunc():'], 'correct': 1}
    ],
    'javascript': [
        {'question': '–ö–∞–∫ –≤—ã–≤–µ—Å—Ç–∏ —Ç–µ–∫—Å—Ç –≤ JavaScript?', 'options': ['print("text")', 'console.log("text")', 'echo "text"', 'System.out.println("text")'], 'correct': 1},
        {'question': '–ö–∞–∫ –æ–±—ä—è–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≤ JS?', 'options': ['var x;', 'let x;', 'const x;', '–í—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã'], 'correct': 3},
        {'question': '–ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å –º–∞—Å—Å–∏–≤ –≤ JS?', 'options': ['[]', '{}', '()', '<>'], 'correct': 0}
    ],
    'java': [
        {'question': '–ö–∞–∫ –≤—ã–≤–µ—Å—Ç–∏ —Ç–µ–∫—Å—Ç –≤ Java?', 'options': ['print("text")', 'console.log("text")', 'System.out.println("text")', 'echo "text"'], 'correct': 2},
        {'question': '–ß—Ç–æ —Ç–∞–∫–æ–µ JVM?', 'options': ['Java Virtual Machine', 'Java Visual Model', 'Java Variable Memory', 'Java Version Manager'], 'correct': 0},
        {'question': '–ö–∞–∫–æ–µ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –¥–ª—è –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è?', 'options': ['extends', 'implements', 'inherits', 'super'], 'correct': 0}
    ]
}

# ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
logging.basicConfig(level=logging.INFO)
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher(bot)
dp.middleware.setup(LoggingMiddleware())

# ========== –†–ê–ë–û–¢–ê –° –ë–ê–ó–û–ô –î–ê–ù–ù–´–• ==========
conn = sqlite3.connect('trainer.db', check_same_thread=False)
cursor = conn.cursor()

# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
cursor.executescript('''
    CREATE TABLE IF NOT EXISTS users (
        user_id INTEGER PRIMARY KEY,
        username TEXT,
        first_name TEXT,
        registered_at TEXT
    );
    
    CREATE TABLE IF NOT EXISTS stats (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER,
        language TEXT,
        correct_answers INTEGER,
        total_questions INTEGER,
        date TEXT
    );
    
    CREATE TABLE IF NOT EXISTS user_sessions (
        user_id INTEGER PRIMARY KEY,
        language TEXT,
        question_index INTEGER,
        correct_count INTEGER,
        total_count INTEGER
    );
''')
conn.commit()

# ========== –§–£–ù–ö–¶–ò–ò –ë–ê–ó–´ –î–ê–ù–ù–´–• ==========
def add_user(user_id, username, first_name):
    cursor.execute('INSERT OR IGNORE INTO users VALUES (?, ?, ?, ?)',
                   (user_id, username, first_name, datetime.now().strftime("%Y-%m-%d %H:%M:%S")))
    conn.commit()

def start_session(user_id, language):
    cursor.execute('INSERT OR REPLACE INTO user_sessions VALUES (?, ?, 0, 0, ?)',
                   (user_id, language, len(QUESTIONS[language])))
    conn.commit()

def update_session(user_id, question_index, correct_count):
    cursor.execute('UPDATE user_sessions SET question_index = ?, correct_count = ? WHERE user_id = ?',
                   (question_index, correct_count, user_id))
    conn.commit()

def get_session(user_id):
    cursor.execute('SELECT * FROM user_sessions WHERE user_id = ?', (user_id,))
    return cursor.fetchone()

def end_session(user_id):
    cursor.execute('DELETE FROM user_sessions WHERE user_id = ?', (user_id,))
    conn.commit()
def save_stats(user_id, language, correct, total):
    cursor.execute('INSERT INTO stats (user_id, language, correct_answers, total_questions, date) VALUES (?, ?, ?, ?, ?)',
                   (user_id, language, correct, total, datetime.now().strftime("%Y-%m-%d")))
    conn.commit()

def get_user_stats(user_id):
    cursor.execute('SELECT language, correct_answers, total_questions, date FROM stats WHERE user_id = ? ORDER BY date DESC', (user_id,))
    return cursor.fetchall()

# ========== –ö–õ–ê–í–ò–ê–¢–£–†–´ ==========
def main_keyboard():
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add(KeyboardButton("üìö –ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É"))
    kb.add(KeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"), KeyboardButton("‚ÑπÔ∏è –û –±–æ—Ç–µ"))
    return kb

def languages_keyboard():
    kb = InlineKeyboardMarkup(row_width=2)
    kb.add(
        InlineKeyboardButton("Python", callback_data="lang_python"),
        InlineKeyboardButton("JavaScript", callback_data="lang_javascript"),
        InlineKeyboardButton("Java", callback_data="lang_java")
    )
    return kb

# ========== –û–¢–ü–†–ê–í–ö–ê –í–û–ü–†–û–°–ê ==========
async def send_question(user_id, language, q_index):
    questions = QUESTIONS[language]
    
    if q_index >= len(questions):
        session = get_session(user_id)
        if session:
            _, _, _, correct, total = session
            save_stats(user_id, language, correct, total)
            end_session(user_id)
            
            percent = (correct / total) * 100
            await bot.send_message(user_id,
                f"üéâ –ó–∞–≤–µ—Ä—à–µ–Ω–æ!\n{language.capitalize()}: {correct}/{total} ({percent:.1f}%)",
                reply_markup=main_keyboard())
        return
    
    q = questions[q_index]
    kb = InlineKeyboardMarkup(row_width=1)
    for i, opt in enumerate(q['options']):
        kb.add(InlineKeyboardButton(opt, callback_data=f"ans_{language}_{q_index}_{i}"))
    
    await bot.send_message(user_id, f"‚ùì –í–æ–ø—Ä–æ—Å {q_index + 1}/{len(questions)}\n\n{q['question']}", 
                          reply_markup=kb, parse_mode="Markdown")

# ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ==========
@dp.message_handler(commands=['start'])
async def cmd_start(msg: types.Message):
    add_user(msg.from_user.id, msg.from_user.username, msg.from_user.first_name)
    await msg.answer(f"üëã –ü—Ä–∏–≤–µ—Ç, {msg.from_user.first_name}!\n–Ø —Ç—Ä–µ–Ω–∞–∂–µ—Ä –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—é.", 
                    reply_markup=main_keyboard())

@dp.message_handler(lambda m: m.text == "üìö –ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É")
async def choose_lang(msg: types.Message):
    await msg.answer("–í—ã–±–µ—Ä–∏ —è–∑—ã–∫:", reply_markup=languages_keyboard())

@dp.message_handler(lambda m: m.text == "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
async def show_stats(msg: types.Message):
    stats = get_user_stats(msg.from_user.id)
    if not stats:
        await msg.answer("üìä –ü–æ–∫–∞ –Ω–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.", reply_markup=main_keyboard())
        return
    
    text = "üìä –¢–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n\n"
    for lang, corr, total, date in stats:
        text += f"‚Ä¢ {lang.capitalize()}: {corr}/{total} ({(corr/total*100):.1f}%)\n  üìÖ {date}\n\n"
    
    await msg.answer(text, reply_markup=main_keyboard())

@dp.message_handler(lambda m: m.text == "‚ÑπÔ∏è –û –±–æ—Ç–µ")
async def about(msg: types.Message):
    await msg.answer(
        "ü§ñ –¢—Ä–µ–Ω–∞–∂–µ—Ä –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—é v1.0\n"
        "–Ø–∑—ã–∫–∏: Python, JavaScript, Java\n\n"
        "–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:\n"
        "1. –ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É\n"
        "2. –í—ã–±—Ä–∞—Ç—å —è–∑—ã–∫\n"
        "3. –û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã",
        reply_markup=main_keyboard())

@dp.callback_query_handler(lambda c: c.data.startswith('lang_'))
async def process_language(call: types.CallbackQuery):
    lang = call.data.replace('lang_', '')
    start_session(call.from_user.id, lang)
    await send_question(call.from_user.id, lang, 0)
    await bot.answer_callback_query(call.id)

@dp.callback_query_handler(lambda c: c.data.startswith('ans_'))
async def process_answer(call: types.CallbackQuery):
    _, lang, q_idx, ans_idx = call.data.split('_')
    q_idx, ans_idx = int(q_idx), int(ans_idx)
    user_id = call.from_user.id
    
    session = get_session(user_id)
    if not session:
        await bot.answer_callback_query(call.id, "–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ù–∞—á–Ω–∏ –∑–∞–Ω–æ–≤–æ!")
        return
    
    _, _, _, correct, _ = session
    is_correct = (ans_idx == QUESTIONS[lang][q_idx]['correct'])
    
    if is_correct:
        correct += 1
        await bot.answer_callback_query(call.id, "‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!")
    else:
        correct_ans = QUESTIONS[lang][q_idx]['options'][QUESTIONS[lang][q_idx]['correct']]
        await bot.answer_callback_query(call.id, f"‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!\n–ü—Ä–∞–≤–∏–ª—å–Ω–æ: {correct_ans}", show_alert=True)
    
    update_session(user_id, q_idx + 1, correct)
    await send_question(user_id, lang, q_idx + 1)

@dp.message_handler()
async def other(msg: types.Message):
    await msg.answer("–ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é.", reply_markup=main_keyboard())

# ========== –ó–ê–ü–£–°–ö ==========
if name == 'main':
    executor.start_polling(dp, skip_updates=True)
